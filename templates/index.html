<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover">
    <title>哈基米个人站</title>

    <!-- PWA / App 通配：manifest + 图标 + 移动适配 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ea868f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="LilyXUAN">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon"  href="/images/main_icon.png">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 页面整体布局 */

        .page-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 友链分组 */
        .friend-section {
            margin-bottom: 50px;
            /* 保持横向并列，允许换行 */
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            align-items: flex-start;
        }

        /* 每个 .friend-cards 作为一个紧凑的列容器，不占满整行，
           当一个 .friend-cards 内有多个卡片时也按列排列，和“项目开发者”组行为一致 */
        .friend-cards {
            display: inline-grid;
            grid-auto-flow: column;
            grid-auto-columns: 320px;
            /* 固定卡片显示宽度，长宽保持不变 */
            gap: 18px;
            align-items: start;
            vertical-align: top;
            min-width: 0;
        }

        .friend-card {
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            border: 1px solid var(--border-color);
            text-decoration: none;
            /* 移除下划线 */
            overflow: hidden;
            box-sizing: border-box;
            height: auto;
            /* 不强制等高，标签区贴底 */
            width: 100%;
            /* 适配 grid-auto-columns 指定的宽度 */
            max-width: 320px;
            break-inside: avoid;
        }

        /* 让卡片内容撑满高度，标签区贴底 */
        .friend-header+.friend-desc {
            margin-bottom: 12px;
        }

        .friend-tags {
            margin-top: auto;
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .friend-avatar {
            width: 54px;
            height: 54px;
            border-radius: 12px;
            /* 方形圆角头像 */
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .friend-link {
            font-size: 0.85rem;
            color: var(--themecolor);
            opacity: 0.8;
        }

        .friend-desc {
            margin-top: 12px;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .friend-tags {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .friend-tag {
            padding: 3px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            opacity: 0.8;
        }

        /* 暗色模式适配 */
        [data-theme="dark"] .friend-card:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* 申请友链部分 */
        .apply-section {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom: 2px solid var(--themecolor);
            color: var(--themecolor);
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .blog-info {
            background-color: rgba(234, 134, 143, 0.1);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--themecolor);
            font-size: 1.2rem;
        }

        .info-item {
            margin-bottom: 10px;
            display: flex;
        }

        .info-label {
            min-width: 80px;
            font-weight: 500;
        }

        .requirements {
            margin-bottom: 20px;
        }

        .requirement-list {
            padding-left: 20px;
            margin: 20px 0;
        }

        .requirement-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .code-block {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 20px 0;
            line-height: 1.5;
        }

        /* 侧边栏 */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 天气 / 访客 IP 小部件 */
        .weather-widget {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        .weather-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .weather-icon {
            font-size: 1.6rem;
        }

        .weather-location {
            font-weight: 600;
        }

        .weather-temp {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--themecolor);
        }

        .weather-note {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .sidebar-widget {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .widget-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--themecolor);
            position: relative;
            padding-bottom: 10px;
        }

        .widget-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background-color: var(--themecolor);
            border-radius: 2px;
        }

        .category-list,
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-item,
        .tag-item {
            background-color: var(--bg-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text-color);
        }

        .category-item:hover,
        .tag-item:hover {
            background-color: var(--themecolor);
            color: white;
        }

        .search-form {
            display: flex;
            margin-top: 15px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px 0 0 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .search-button {
            background-color: var(--themecolor);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
        }

        /* 页脚 */
        .footer {
            text-align: center;
            padding: 40px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
        }


            /* 小屏时恢复传统网格布局，避免横向溢出 */
            .friend-section {
                display: block;
            }

            .friend-cards {
                display: grid;
                grid-auto-flow: row;
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                width: 100%;
            }
        

        @media (max-width: 768px) {
            .top-nav {
                padding: 0 20px;
            }

            .main-nav {
                display: none;
            }

            .friend-cards {
                grid-template-columns: 1fr;
            }

            .sidebar {
                grid-template-columns: 1fr;
            }

            .container {
                padding: calc(var(--header-height) + 20px) 20px 20px;
            }
        }

        @media (max-width: 480px) {
            .logo-text {
                font-size: 1.2rem;
            }

            .social-links {
                gap: 10px;
            }

            .social-link,
            .theme-toggle {
                width: 35px;
                height: 35px;
            }
        }
    </style>
</head>

<body data-theme="light">
    <!-- 顶部导航栏 -->
    <nav class="top-nav">
        <div class="logo">
            <img src="/images/main_icon.png"
                alt="哈基米的空间" class="logo-img">
            <div class="logo-text">哈基米个人站</div>
        </div>
        <div class="main-nav">
            <a href="/" class="nav-link active">首页&友链</a>
            <a href="/posts" class="nav-link">记录</a>
            <a href="/about" class="nav-link">关于</a>
            <a href="/license" class="nav-link">LICENSE</a>
        </div>
        <div class="nav-right">
            <div class="social-links">
                <a href="https://github.com/Li-zhienxuan" class="social-link" target="_blank" title="GitHub">
                    <i class="fab fa-github"></i>
                </a>
                <a href="https://gitee.com/li-zhienxuan_study" class="social-link" target="_blank" title="Gitee">
                    <i class="fab fa-git-alt"></i>
                </a>
                <a href="https://space.bilibili.com/473911887" class="social-link" target="_blank" title="Bilibili">
                    <i class="fab fa-bilibili"></i>
                </a>
                <a href="mailto:Li.zhienxuan0516@gmail.com" class="social-link" title="Email">
                    <i class="far fa-envelope"></i>
                </a>
            </div>

            <button class="theme-toggle" id="theme-toggle" aria-label="切换主题">
                <i class="fas fa-moon"></i>
            </button>

            <!-- PWA 安装按钮（仅在支持时显示） -->
            <button class="theme-toggle" id="install-btn" aria-label="安装应用" style="display:none;margin-left:8px">
                <i class="fas fa-download"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="container">
        <!-- 左侧内容 -->
        <main class="main-content">
            <div class="page-header">
                <img src="/images/main_icon.png"
                    alt="作者头像" class="author-avatar">
                <div>
                    <h1 class="page-title">友链</h1>
                    <div class="page-meta">
                        <div class="meta-item">
                            <i class="far fa-calendar"></i>
                            <span id="current-time"></span>
                        </div>
                        <div class="meta-item">
                            <!-- <i class="far fa-comment"></i> -->
                            <!-- <span>1 条评论</span> -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="friend-section">
                <h2 class="section-title">我的友友们</h2>
                <div class="friend-cards">
                    <a class="friend-card" href="https://blog.811311.xyz/" target="_blank" rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="https://q2.qlogo.cn/headimg_dl?dst_uin=2739043475&spec=5" alt="白夭夭"
                                class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">白夭夭</h3>
                                <span class="friend-link">夭夭的博客</span>
                            </div>
                        </div>
                        <p class="friend-desc">夭夭随笔，选择性失忆综合症</p>
                        <div class="friend-tags">
                            <span class="friend-tag">水文随笔</span>
                            <span class="friend-tag">美食</span>
                            <span class="friend-tag">夭夭回忆录</span>
                        </div>
                    </a>
                </div>

                <div class="friend-cards" style="margin-top:18px">
                    <a class="friend-card" href="https://blog.hslzz.cn/" target="_blank" rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="https://hslzz.cn/assets/img/favicon.png" alt="花生莲子粥" class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">花生莲子粥</h3>
                                <span class="friend-link">花生莲子粥の小窝</span>
                            </div>
                        </div>
                        <p class="friend-desc">与世无争，不染于泥</p>
                        <div class="friend-tags">
                            <span class="friend-tag">技术分享</span>
                            <span class="friend-tag">服务器运维</span>
                            <span class="friend-tag">Ubuntu</span>
                        </div>
                    </a>
                </div>
                <div class="friend-cards" style="margin-top:18px">
                    <a class="friend-card" href="https://space.bilibili.com/3546554881280375" target="_blank"
                        rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="/images/taomuyu.jpg" alt="桃木雨" class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">桃木雨</h3>
                                <span class="friend-link">好巧，你也喜欢我呀，那我们真是太有眼光了</span>
                            </div>
                        </div>
                        <p class="friend-desc">我的被子生病了，我要在床上照顾它</p>
                        <div class="friend-tags">
                            <span class="friend-tag">吉他</span>
                            <span class="friend-tag">尤克里里</span>
                            <span class="friend-tag">弹唱</span>
                            <span class="friend-tag">Bilibili UP</span>
                            <!-- <span class="friend-tag">八卦</span> -->
                        </div>
                    </a>
                </div>

                <div class="friend-cards" style="margin-top:18px">
                    <a class="friend-card" href="https://space.bilibili.com/1164913332" target="_blank"
                        rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="/images/xiaomei.jpg" alt="梨子Light" class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">梨子Light</h3>
                                <span class="friend-link">至少还有你，值得我去珍惜</span>
                            </div>
                        </div>
                        <p class="friend-desc">日常乱唱ing</p>
                        <div class="friend-tags">
                            <span class="friend-tag">吉他</span>
                            <span class="friend-tag">粤语</span>
                            <span class="friend-tag">弹唱</span>
                            <span class="friend-tag">Bilibili UP</span>
                        </div>
                    </a>
                </div>
            </div>

            <div class="friend-section">
                <h2 class="section-title">项目开发者</h2>
                <div class="friend-cards">
                    <a class="friend-card" href="https://webui.nbgui.top/" target="_blank" rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="https://webui.nbgui.top/logo.png" alt="墨希MoXiify" class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">NoneBot WebUI</h3>
                                <span class="friend-link"></span>
                            </div>
                        </div>
                        <!-- <p class="friend-desc">【夜风】NightWind</p> -->
                        <p class="friend-desc">新一代 NoneBot Web 管理界面</p>
                        <div class="friend-tags">
                            <span class="friend-tag">NoneBot</span>
                            <span class="friend-tag">WebUI</span>
                            <span class="friend-tag">[夜风] NightWind</span>
                        </div>
                    </a>

                </div>


                <div class="friend-cards" style="margin-top:18px">
                    <a class="friend-card" href="https://www.495000.xyz" target="_blank" rel="noopener noreferrer">
                        <div class="friend-header">
                            <img src="/images/zhazhahui.jpg" alt="Jack" class="friend-avatar">
                            <div class="friend-info">
                                <h3 class="friend-name">Jack</h3>
                                <span class="friend-link">好巧，你如果你需要公益服玩游戏，如果你需要学技术，那你真是太有眼光了 谁想我加入我们</span>
                            </div>
                        </div>
                        <p class="friend-desc">小时有一个梦想，成为一个公益的人</p>
                        <div class="friend-tags">
                            <span class="friend-tag">公益服主</span>
                            <span class="friend-tag">技术型选手</span>
                            <span class="friend-tag">各类公益服</span>
                            <span class="friend-tag">大厂IT攻防选手</span>
                            <span class="friend-tag">各类技术解答师</span>
                            <span class="friend-tag">刑法民法双科满分顶级法学生</span>
                        </div>
                    </a>
                </div>
            </div>

            <div class="apply-section">
                <h2 class="section-title">结友</h2>

                <div class="tabs">
                    <div class="tab active" data-tab="blog-info">博客信息</div>
                    <div class="tab" data-tab="requirements">友链要求</div>
                    <div class="tab" data-tab="apply">申请友链</div>
                </div>

                <div class="tab-content active" id="blog-info">
                    <div class="blog-info">
                        <div class="info-title">哈基米</div>
                        <div class="info-item">
                            <span class="info-label">名称：</span>
                            <span>哈基米个人站</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">地址：</span>
                            <span><a href="https://lilyxuan.online" target="_blank">https://lilyxuan.online</a></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">描述：</span>
                            <span>这里是哈基米个人站，分享技术，热爱生活</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">头像：</span>
                            <span><a href="/images/main_icon.png" target="_blank">点击查看</a></span>
                                   
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="requirements">
                    <div class="requirements">
                        <p>友链有以下要求：</p>
                        <ul class="requirement-list">
                            <li>站内不得是大量AI生成的（无意义的）文章</li>
                            <li>接受个人博客/导航页</li>
                            <li>交友结识为主</li>
                            <li>申请友链前请先添加本站友链</li>
                        </ul>
                        <p>如果没有留下友链或是长期无法访问的网站，本站会删除友链，请你理解</p>
                        <p>留好友链后可以留言，如果合适会为您添加友链，谢谢！</p>
                    </div>
                </div>

                <div class="tab-content" id="apply">
                    <p>如果你想申请友链，留下你的信息</p>
                    <p>友链申请部分站长正在开发中，有需要请直接主页邮箱联系，喵喵喵~</p>
                    <p>参考内容如下：</p>
                    <div class="code-block">

                        name: 昵称<br
                        desc: 个人描述<br>
                        link: 博客链接<br>
                        icon: 头像链接<br>    
                        tags: 标签1, 标签2, ...<br>
                        sublink: 副标题文本
                    </div>
                </div>
            </div>
        </main>

        <!-- 右侧边栏 -->
        <aside class="sidebar">
            <!-- <div class="sidebar-widget">
                <h3 class="widget-title">搜索</h3>
                <form class="search-form">
                    <input type="text" class="search-input" placeholder="输入关键词搜索...">
                    <button type="submit" class="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div> -->

            <!-- 访客 IP 与天气 -->
            <div id="weather-widget" class="weather-widget" aria-live="polite">
                <div class="weather-top">
                    <div class="weather-icon" id="weather-icon">🌤️</div>
                    <div>
                        <div class="weather-location" id="weather-location">正在获取位置…</div>
                        <div class="weather-note" id="visitor-ip">IP: —</div>
                    </div>
                </div>
                <div>
                    <div>当前： <span class="weather-temp" id="weather-temp">--°C</span></div>
                    <div class="weather-note" id="weather-desc">—</div>
                </div>
            </div>

            <div class="sidebar-widget">
                <h3 class="widget-title">分类</h3>
                <div class="category-list">
                    <a href="#" class="category-item">技术</a>
                    <a href="#" class="category-item">生活</a>
                    <!-- <a href="#" class="category-item">设计</a> -->
                    <a href="#" class="category-item">随笔</a>
                    <!-- <a href="#" class="category-item">旅行</a> -->
                </div>
            </div>

            <div class="sidebar-widget">
                <h3 class="widget-title">标签</h3>
                <div class="tag-list">
                    <!-- <a href="#" class="tag-item">前端</a> -->
                    <!-- <a href="#" class="tag-item">JavaScript</a> -->
                    <!-- <a href="#" class="tag-item">CSS</a> -->
                    <!-- <a href="#" class="tag-item">React</a> -->
                    <!-- <a href="#" class="tag-item">Vue</a> -->
                    <!-- <a href="#" class="tag-item">Node.js</a> -->
                    <!-- <a href="#" class="tag-item">设计</a> -->
                    <!-- <a href="#" class="tag-item">UX</a> -->
                </div>
            </div>

            <div class="sidebar-widget">
                <h3 class="widget-title">关于</h3>
                <p>这里是哈基米个人站，分享技术，热爱生活</p>
            </div>
        </aside>
    </div>

    <footer class="footer"
        style="text-align: center; padding: 2rem 0; margin-top: 3rem; border-top: 1px solid #eaeaea; color: #666; font-size: 0.9rem;">
        <p>© 2025 哈基米的空间 All Rights Reserved</p>
        <p>Powered by <a href="https://www.getzola.org" target="_blank" rel="noopener"
                style="color: #7c3aed; text-decoration: none; font-weight: bold;">Zola</a> ·Theme by 哈基米</p>
        <p style="line-height: 1.6;">

            <p>本项目采用 <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank" rel="noopener"
                style="color: #2563eb; text-decoration: none; font-weight: bold;">
                GPL v3.0
            </a> 许可证发布</p>

            
            <!-- · 自由使用 · 修改分发 · 开源共享 -->
        </p>

        </p>
    </footer>

    <script>
        // 合并：主题切换 + 选项卡功能 + PWA 安装逻辑 + ServiceWorker 注册（避免重复声明）
        (function () {
            // 主题切换
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = themeToggleBtn && themeToggleBtn.querySelector('i');
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                if (themeIcon) themeIcon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const currentTheme = document.body.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    document.body.setAttribute('data-theme', newTheme);
                    if (themeIcon) themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                    localStorage.setItem('theme', newTheme);
                });
            }

            // 选项卡功能
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // 实时时分秒显示（每秒更新）
            (function () {
                const el = document.getElementById('current-time');
                if (!el) return;
                const pad = n => String(n).padStart(2, '0');
                const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                function render() {
                    const d = new Date();
                    el.textContent = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${weekdays[d.getDay()]} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
                }
                render();
                setInterval(render, 1000);
            })();

            // 获取访客 IP 与天气（多服务回退 + 超时 + geolocation 备用）
            (function () {
                const ipEl = document.getElementById('visitor-ip');
                const locEl = document.getElementById('weather-location');
                const tempEl = document.getElementById('weather-temp');
                const descEl = document.getElementById('weather-desc');
                const iconEl = document.getElementById('weather-icon');

                const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));
                const fetchJSON = (url, ms = 6000) => Promise.race([fetch(url).then(r => r.ok ? r.json() : Promise.reject(r)), timeout(ms)]);

                function weatherCodeToText(code) {
                    if (code === 0) return '晴朗';
                    if (code <= 3) return '多云';
                    if (code === 45 || code === 48) return '雾';
                    if (code >= 51 && code <= 67) return '小雨';
                    if (code >= 71 && code <= 77) return '小雪';
                    if (code >= 80 && code <= 82) return '阵雨';
                    if (code >= 95) return '雷暴';
                    return '多变';
                }
                function weatherCodeToEmoji(code) {
                    if (code === 0) return '☀️';
                    if (code <= 3) return '⛅';
                    if (code === 45 || code === 48) return '🌫️';
                    if (code >= 51 && code <= 67) return '🌧️';
                    if (code >= 71 && code <= 77) return '❄️';
                    if (code >= 80 && code <= 82) return '🌦️';
                    if (code >= 95) return '⚡';
                    return '🌤️';
                }

                async function getIpData() {
                    const services = [
                        'https://ipapi.co/json/',
                        'https://ipwho.is/json/'
                    ];
                    for (const url of services) {
                        try {
                            const d = await fetchJSON(url, 6000);
                            if (d && (d.ip || d.success === true || d.ip_address)) return d;
                        } catch (e) {
                            // 继续下一个服务
                        }
                    }
                    return null;
                }

                async function getCoordsViaGeolocation() {
                    if (!navigator.geolocation) return null;
                    return new Promise((resolve) => {
                        const done = (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude });
                        const fail = () => resolve(null);
                        navigator.geolocation.getCurrentPosition(done, fail, { maximumAge: 600000, timeout: 8000 });
                    });
                }

                (async () => {
                    try {
                        const data = await getIpData();
                        let lat = null, lon = null;
                        if (data) {
                            const ip = data.ip || data.ip_address || '—';
                            if (ipEl) ipEl.textContent = `IP: ${ip}`;
                            const city = data.city || data.city || '';
                            const region = data.region || data.region || data.regionName || '';
                            const country = data.country_name || data.country || data.countryCode || '';
                            if (locEl) locEl.textContent = [city, region, country].filter(Boolean).join(' · ') || '未知位置';
                            lat = data.latitude ?? data.lat ?? data.latitude;
                            lon = data.longitude ?? data.lon ?? data.longitude;
                        } else {
                            if (ipEl) ipEl.textContent = 'IP: 无法获取';
                            if (locEl) locEl.textContent = '尝试定位中…';
                        }

                        if (lat == null || lon == null) {
                            // 尝试浏览器定位
                            const geo = await getCoordsViaGeolocation();
                            if (geo) {
                                lat = geo.latitude;
                                lon = geo.longitude;
                                if (locEl && (!locEl.textContent || locEl.textContent === '尝试定位中…')) locEl.textContent = '通过浏览器定位';
                            }
                        }

                        if (lat != null && lon != null) {
                            const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&timezone=auto`;
                            try {
                                const w = await fetchJSON(url, 7000);
                                const cw = w.current_weather || {};
                                const temp = cw.temperature;
                                const code = cw.weathercode;
                                const wind = cw.windspeed;
                                if (tempEl) tempEl.textContent = (temp != null) ? `${Number(temp).toFixed(1)}°C` : '--°C';
                                if (descEl) descEl.textContent = `${weatherCodeToText(code)} · 风 ${wind ?? '--'} km/h`;
                                if (iconEl) iconEl.textContent = weatherCodeToEmoji(code);
                            } catch (e) {
                                if (descEl) descEl.textContent = '天气服务不可用';
                            }
                        } else {
                            if (descEl) descEl.textContent = '无法获取经纬度';
                            if (tempEl) tempEl.textContent = '--°C';
                            if (iconEl) iconEl.textContent = '—';
                        }
                    } catch (e) {
                        if (ipEl) ipEl.textContent = 'IP: 无法获取';
                        if (locEl) locEl.textContent = '未知位置';
                        if (descEl) descEl.textContent = '天气服务不可用';
                    }
                })();
            })();

            // PWA 安装（beforeinstallprompt）
            let deferredPrompt;
            const installBtn = document.getElementById('install-btn');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installBtn) installBtn.style.display = 'inline-flex';
            });

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const choiceResult = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                    console.log('用户选择: ', choiceResult.outcome);
                });
            }

            // 注册 service worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function () {
                    navigator.serviceWorker.register('/service-worker.js').catch(err => {
                        console.warn('SW 注册失败:', err);
                    });
                });
            }
        })();
    </script>
</body>

</html>